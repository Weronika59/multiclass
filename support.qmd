---
title: "support"
author: "WN"
format: 
  html:
    warning: false
    message: false
    echo: true
    self-contained: true
    self-contained-math: true
    embed-resources: true
    lang: pol
editor: visual
toc: true
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(dplyr)
library(kableExtra)
library(corrplot)
library(tidyr)
library(caret)
library(rstatix)
```

```{r}
dane <- read.csv("C:\\Users\\wnadw\\Desktop\\Pliki studia\\Rok 4\\II stopień\\semestr 1\\Zaawansowane metody uczenia maszynowego\\projekt\\dane UCI\\multiclass\\support2\\multiclass\\support2.csv")
```

## Cel badania

Ten zbiór danych obejmuje 9105 pacjentów w stanie krytycznym z 5 ośrodków medycznych w Stanach Zjednoczonych, do których dostęp uzyskano w latach 1989-1991 i 1992-1994. Każdy wiersz dotyczy rekordów hospitalizowanych pacjentów, którzy spełnili kryteria włączenia i wykluczenia dla dziewięciu kategorii chorób: ostra niewydolność oddechowa, przewlekła obturacyjna choroba płuc, zastoinowa niewydolność serca, choroba wątroby, śpiączka, rak okrężnicy, rak płuc, niewydolność wielonarządowa z nowotworem złośliwym i niewydolność wielonarządowa z sepsą. Celem jest określenie 2- i 6-miesięcznych wskaźników przeżycia tych pacjentów w oparciu o kilka informacji fizjologicznych, demograficznych i dotyczących ciężkości choroby. Jest to ważny problem, ponieważ odnosi się do rosnących obaw narodowych dotyczących utraty kontroli przez pacjentów pod koniec życia. Umożliwia wcześniejsze podejmowanie decyzji i planowanie w celu zmniejszenia częstotliwości mechanicznego, bolesnego i przedłużającego się procesu umierania.

W jakim celu utworzono zbiór danych?

Opracowanie i walidacja modelu prognostycznego, który szacuje przeżycie w okresie 180 dni dla ciężko chorych hospitalizowanych dorosłych (faza I SUPPORT) oraz porównanie przewidywań tego modelu z przewidywaniami istniejącego systemu prognostycznego i niezależnymi szacunkami lekarzy (faza II SUPPORT).

Kto sfinansował utworzenie zbioru danych?

Sfinansowane przez Fundację Roberta Wooda Johnsona

Co reprezentują instancje w tym zbiorze danych?

Instancje reprezentują rekordy krytycznie chorych pacjentów przyjętych do szpitali w Stanach Zjednoczonych z zaawansowanymi stadiami poważnej choroby.

Czy istnieją zalecane podziały danych?

Brak zaleceń, można zastosować standardowy podział na trening i test. Można użyć trójstronnego podziału (tj. trening-walidacja-test) podczas wyboru modelu.

Czy zbiór danych zawiera dane, które można w jakikolwiek sposób uznać za wrażliwe?

Tak. Istnieją informacje o rasie, płci, dochodach i poziomie wykształcenia.

Czy przeprowadzono wstępne przetwarzanie danych?

Ze względu na wysoki odsetek brakujących wartości istnieje kilka zalecanych wartości imputacji: Zgodnie z repozytorium HBiostat (https://hbiostat.org/data/repo/supportdesc, profesor Frank Harrell) następujące wartości domyślne okazały się przydatne w imputacji brakujących podstawowych danych fizjologicznych: Zmienna podstawowa Normalna wartość wypełnienia - Albumina w surowicy (alb) 3.5 - Stosunek PaO2/FiO2 (pafi) 333,3 - Bilirubina (bili) 1,01 - Kreatynina (crea) 1,01 - Bułka 6,51 - Liczba białych krwinek (wblc) 9 (tys.) - Wydalanie moczu (mocz) 2502 Istnieje 159 pacjentów, którzy przeżyli 2 miesiące, w przypadku których nie przeprowadzono wywiadów z pacjentami lub osobami zastępczymi. U tych pacjentów brakuje sfdm2.

Dodatkowe informacje

Źródłami danych są dokumentacja medyczna, wywiady osobiste i Krajowy Indeks Zgonów (NDI). Dla każdego pacjenta zebrano dane z rejestrów administracyjnych, dane kliniczne i dane ankietowe.

Celem projektu SUPPORT była poprawa procesu decyzyjnego, aby odpowiedzieć na rosnące krajowe obawy dotyczące utraty kontroli przez pacjentów pod koniec życia i zmniejszyć częstotliwość mechanicznego, bolesnego i długotrwałego procesu umierania. SUPPORT składał się z dwuletniego prospektywnego badania obserwacyjnego (Faza I), po którym nastąpiło dwuletnie kontrolowane badanie kliniczne (Faza II). W fazie I badania SUPPORT zebrano dane od pacjentów przyjętych w latach 1989-1991 w celu scharakteryzowania opieki, preferencji dotyczących leczenia i wzorców podejmowania decyzji wśród krytycznie chorych pacjentów. Służyła również jako wstępny krok do opracowania strategii interwencji w celu poprawy opieki nad krytycznie chorymi pacjentami oraz do budowy modeli statystycznych do przewidywania rokowania i stanu funkcjonalnego pacjenta. Interwencja została wdrożona w II fazie badania SUPPORT, do której pacjenci byli przyjmowani w latach 1992-1994. Interwencja fazy II dostarczyła lekarzom dokładnych informacji prognostycznych na temat przyszłej zdolności funkcjonalnej, prawdopodobieństwa przeżycia do sześciu miesięcy oraz preferencji pacjentów dotyczących opieki u schyłku życia. Dodatkowo, w ramach interwencji zapewniono wykwalifikowaną pielęgniarkę w celu określenia preferencji pacjenta, przedstawienia prognoz, zwiększenia zrozumienia, umożliwienia opieki paliatywnej i ułatwienia wcześniejszego planowania. Oczekiwano, że interwencja zwiększy komunikację, skutkując wcześniejszymi decyzjami o zleceniu reanimacji, skróci czas spędzany przez pacjentów w niepożądanych stanach (np. na oddziale intensywnej terapii, pod respiratorem i w śpiączce), zwiększy zrozumienie przez lekarzy preferencji pacjentów dotyczących opieki, zmniejszy ból pacjentów i zmniejszy zużycie zasobów szpitalnych. Gromadzenie danych w obu fazach SUPPORT składało się z kwestionariuszy podawanych pacjentom, ich zastępcom i lekarzom, a także przeglądów kart w celu wyodrębnienia informacji klinicznych, leczenia i decyzji. Faza II gromadziła również informacje dotyczące wdrożenia interwencji, takie jak dzienniki dotyczące poszczególnych pacjentów prowadzone przez pielęgniarki przypisane do pacjentów w ramach interwencji. Pacjenci objęci programem SUPPORT byli obserwowani przez sześć miesięcy po włączeniu do badania. Ci, którzy nie zmarli w ciągu sześciu miesięcy lub zostali utraceni w wyniku obserwacji, zostali dopasowani do National Death Index w celu zidentyfikowania zgonów do 1997 roku. Pacjenci, którzy nie zmarli w ciągu jednego roku lub utracili możliwość obserwacji, zostali dopasowani do National Death Index w celu zidentyfikowania zgonów do 1997 r.

Wszyscy pacjenci w pięciu ośrodkach medycznych w Stanach Zjednoczonych, którzy spełnili kryteria włączenia i wykluczenia dla dziewięciu kategorii chorób: ostra niewydolność oddechowa, przewlekła obturacyjna choroba płuc, zastoinowa niewydolność serca, choroba wątroby, śpiączka, rak okrężnicy, rak płuc, niewydolność wielonarządowa z nowotworem złośliwym i niewydolność wielonarządowa z posocznicą. SUPPORT to połączenie pacjentów z 2 badań, z których każde trwało 2 lata. Pierwsza faza dotyczyła 4 301 pacjentów, podczas gdy druga faza dotyczyła 4 804 pacjentów. Pod względem czasu, badania te zostały przeprowadzone w 1989 r. (12 czerwca) do 1991 r. (11 czerwca) dla fazy I oraz w 1992 r. (7 stycznia) do 1994 r. (24 stycznia).

## Opis zbioru badawczego

Do badania zostanie użyty zbiór `SUPPORT2` pochodzący z witryny \[UCI\]( https://archive.ics.uci.edu/dataset/880/support2). Zbiór zawiera dane o 9105 pacjentach opisanych(?) za pomocą 47 cech. Cechy te to:

-   age - wiek pacjenta w latach

-   death (**target**) - Śmierć w dowolnym momencie aż do danych National Death Index (NDI) w dniu 31 grudnia 1994 roku. Niektórzy pacjenci zostali wypisani przed zakończeniem badania i nie byli monitorowani. Autorzy sprawdzili informacje o zgonach. - zakres 0-1

-   sex - płeć pacjenta ("male"/"female")

-   hospdead (**target**) - Śmierć w szpitalu - zakres 0-1

-   slos - Dni od rozpoczęcia badania do wypisu ze szpitala

-   d.time - Dni obserwacji

-   dzgroup - Podkategorie choroby pacjenta obejmują ARF/MOSF z sepsą, CHF, POChP, marskość wątroby, raka okrężnicy, śpiączkę, raka płuc, MOSF z maligną. (poziomy "Lung Cancer", "Cirrhosis", "ARF/MOSF w/Sepsis", "Coma", "CHF", "Colon Cancer", "COPD", "MOSF w/Malig")

-   dzclass - Kategoria choroby pacjenta spośród "ARF/MOSF", "COPD/CHF/Cirrhosis", "Cancer", "Coma".

-   num.co - Liczba jednoczesnych chorób (lub chorób współistniejących) występujących u pacjenta. Wartości są porządkowe, przy czym wyższe wartości wskazują na gorszy stan i szanse na przeżycie.

-   edu - lata edukacji (numeric od 11 do 28)

-   income - Dochód pacjenta. Wymienione wartości to {"\$11-\$25k", "\$25-\$50k", "\>\$50k", "poniżej \$11k"}.

-   scoma - Wynik śpiączki w 3. dniu badania SUPPORT na podstawie skali Glasgow (przewidywany na podstawie modelu).

-   charges - Opłaty szpitalne

-   totcst - Całkowity stosunek kosztów do opłat (RCC) koszt

-   totmcst - Całkowity koszt mikro

-   avtisst - Średni wynik TISS, dni 3-25, gdzie Therapeutic Intervention Scoring System (TISS) to metoda obliczania kosztów na oddziale intensywnej terapii (OIT) i oddziale opieki pośredniej (IMCU).

-   race - Rasa pacjenta. Wymienione wartości to {asian, black, hispanic, missing, other, white}.

-   sps - Wynik fizjologii SUPPORT w dniu 3 (przewidywany przez model).

-   aps - Wynik fizjologiczny APACHE III dzień 3 (brak śpiączki, imp bun, uout dla fazy 1)

-   surv2m - Model SUPPORT Szacunkowe 2-miesięczne przeżycie w 3. dniu (przewidywane przez model)

-   surv6m - Model SUPPORT Szacunkowe 6-miesięczne przeżycie w 3. dniu (przewidywane przez model)

-   hday - Dzień pobytu w szpitalu, w którym pacjent został włączony do badania.

-   diabetes - Czy u pacjenta występuje cukrzyca (Com 27-28, Dx 73) jako choroba współistniejąca (Y) czy nie (N).

-   dementia - Czy u pacjenta występuje demencja (choroba współistniejąca 6) jako choroba współistniejąca (T) czy nie (N).

-   ca - Czy pacjent ma raka (tak), czy rak się rozprzestrzenił (przerzuty) lub czy jest zdrowy (nie).

-   prg2m - Oszacowane przez lekarza 2-miesięczne przeżycie pacjenta. -- zamienić na categorical??

-   prg6m - Szacowane przez lekarza 6-miesięczne przeżycie pacjenta. -- -\|\|-

-   dnr - Określa, czy pacjent ma nakaz nieresuscytowania (DNR). Możliwe wartości to dnr after sadm, dnr before sadm, missing, no dnr.

-   dnrday - Dzień zlecenia DNR (\<0, jeśli przed badaniem)

-   meanbp - średnie ciśnienie tętnicze krwi pacjenta mierzone w dniu 3.

-   wblc - liczba białych krwinek (w tysiącach) zmierzona w dniu 3.

-   hrt - częstość akcji serca pacjenta mierzona w dniu 3.

-   resp - częstość oddechów pacjenta mierzona w dniu 3.

-   temp - temperatura w stopniach Celsjusza zmierzona w dniu 3.

-   pafi - Stosunek PaO_2/FiO_2 zmierzony w dniu 3. Stosunek tętniczego ciśnienia parcjalnego tlenu (PaO2 w mmHg) do frakcji wdychanego tlenu (FiO2 wyrażone jako ułamek). Powszechnie stosowany kliniczny wskaźnik hipoksemii, choć jego przydatność diagnostyczna jest kontrowersyjna. Określone zakresy wartości mogą być związane z różnymi poziomami śmiertelności. Warto rozważyć podzielenie tych wartości według pewnych zakresów: https://litfl.com/pao2-fio2-ratio/

-   alb - poziom albuminy w surowicy mierzony w dniu 3.

-   bili - poziom bilirubiny mierzony w dniu 3.

-   crea - poziom kreatyniny w surowicy mierzony w dniu 3.

-   sod - stężenie sodu w surowicy mierzone w dniu 3.

-   ph - pH krwi tętniczej. Wartość pH krwi wynosi zwykle od 7,35 do 7,45. Nieprawidłowe wyniki mogą być spowodowane chorobami płuc, nerek, chorobami metabolicznymi lub przyjmowanymi lekami. Urazy głowy lub szyi lub inne urazy wpływające na oddychanie również mogą prowadzić do nieprawidłowych wyników.

-   glocuse - Poziom glukozy mierzony w dniu 3.

-   bun - Poziom azotu mocznikowego we krwi mierzony w dniu 3.

-   urine - Wydalanie moczu mierzone w 3. dniu.

-   adlp - Indeks czynności życia codziennego (ADL) pacjenta, wypełniany przez pacjenta. Wyższe wartości wskazują na większe szanse na przeżycie, mierzone w dniu 3.

-   adls - Indeks czynności życia codziennego (ADL) pacjenta, wypełniany przez osobę zastępczą (np. członka rodziny), mierzony w 3. dniu. Wyższe wartości wskazują na większe szanse na przeżycie.

-   sfdm2 (**target**) - Poziom niepełnosprawności funkcjonalnej pacjenta w skali od 1 do 5, gdzie 5 oznacza najwyższy stopień nasilenia. Wartości uzyskano za pomocą pytań skierowanych do pacjenta i/lub osób zastępczych w celu określenia wpływu profilu choroby (SIP). Wartości są skorelowane z kolumnami ADLS, ADLP. Wymienione wartości to: {1: "no(Month 2 and SIP pres)", "adl\>=4 (\>=5 if sur)", "SIP\>=30", "Coma or Intub", 5: "\<2 mo. follow-up"}. Istnieje 159 pacjentów, którzy przeżyli 2 miesiące, dla których nie przeprowadzono wywiadów z pacjentami lub osobami zastępczymi. U tych pacjentów brakuje sfdm2.

-   adlsc - Imputowany ADL skalibrowany do surogatu.

Poniżej zaprezentowano pierwsze pięć obserwacji ze zbioru badawczego.

```{r}
head(dane, 5) |> kable() |> kable_styling()
```

Z opisu poszczególnych zmiennych oraz z powyższej tabelki, widzimy, że konieczne jest m. in. zamiana pewnych cech na zmienne kategoryczne, zamiana ich poziomów na liczby. Widocznych jest także kilka kolumn, w których widoczne są braki danych. Dodatkowo wiek został przedstawiony jako liczba zmiennoprzecinkowa z dokładnością do 5. miejsca po przecinku.

Na tym etapie zostaną wprowadzone następujące zmiany:

```{r}
dane$death <- as.factor(dane$death)
dane$hospdead <- as.factor(dane$hospdead)
dane$diabetes <- as.factor(dane$diabetes)
dane$dementia <- as.factor(dane$dementia)
dane$sex <- ifelse(dane$sex=="male", 0, 1)
dane$sex <- as.factor(dane$sex)
dane$dzgroup <- ifelse(dane$dzgroup=="Lung Cancer", 1, ifelse(dane$dzgroup=="Cirrhosis", 2, ifelse(dane$dzgroup=="Coma", 3, ifelse(dane$dzgroup=="CHF", 4, ifelse(dane$dzgroup=="Colon Cancer", 5, ifelse(dane$dzgroup=="COPD", 6, ifelse(dane$dzgroup=="MOSF w/Malig", 7, 8)))))))
dane$dzgroup <- as.factor(dane$dzgroup)
dane$dzclass <- ifelse(dane$dzclass=="Cancer", 1, ifelse(dane$dzclass=="ARF/MOSF", 2, ifelse(dane$dzclass=="Coma", 3, 4)))
dane$dzclass <- as.factor(dane$dzclass)
dane$income <- ifelse(dane$income=="under $11k", 1, ifelse(dane$income=="$11-$25k", 2, ifelse(dane$income=="$25-$50k", 3, ifelse(dane$income==">$50k", 4, NA))))
dane$income <- as.factor(dane$income)
dane$race <- ifelse(dane$race=="white", 1, ifelse(dane$race=="black", 2, ifelse(dane$race=="asian", 3, ifelse(dane$race=="hispanic", 4, ifelse(dane$race=="other", 5, NA)))))
dane$race <- as.factor(dane$race)
dane$ca <- ifelse(dane$ca=="no", 0, ifelse(dane$ca=="yes", 1, 2))
dane$ca <- as.factor(dane$ca)
dane$dnr <- ifelse(dane$dnr=="no dnr", 0, ifelse(dane$dnr=="dnr after sadm", 1, ifelse(dane$dnr=="dnr before sadm", 2, NA)))
dane$dnr <- as.factor(dane$dnr)
dane$sfdm2 <- ifelse(dane$sfdm2=="<2 mo. follow-up", 1, ifelse(dane$sfdm2=="no(M2 and SIP pres)", 2, ifelse(dane$sfdm2=="SIP>=30", 3, ifelse(dane$sfdm2=="adl>=4 (>=5 if sur)", 4, ifelse(dane$sfdm2=="Coma or Intub", 5, NA)))))
dane$sfdm2 <- as.factor(dane$sfdm2)
```

-   zmienna death - factor +

-   sex - 0-1 i factor +

-   hospdead - factor +

-   dzgroup - 8 poziomów, factor +

-   dzclass - 4 poziomy, factor +

-   income - 4 poziomy + NA, factor +

-   race - 5 poziomów + NA, factor +

-   surv2m, surv6m, prg2m, prg6m - czy zamienić na liczby 0-1???

-   diabetes, dementia - factor +

-   ca - 3 poziomy, factor +

-   dnr - 3 poziomy + NA, factor +

-   sfdm2 - 5 poziomów + NA, factor +

-   dnrday - Dzień zlecenia DNR (\<0, jeśli przed badaniem) - zamienić \<0 na 0???? \<----

Poniżej przedstawiono pierwszych 5 wierszy ramki danych po wymienionych wyżej transformacjach.

```{r}
head(dane, 5) |> kable() |> kable_styling()
```

Poniżej zaprezentowane są podstawowe statystyki opisowe dla zmiennych numerycznych:

```{r}
options(knitr.kable.NA=0)
pods <- sub(".*:", "",summary(dane[,c("age","slos", "d.time", "num.co", "edu", "scoma", "charges", "totcst", "totmcst", "avtisst", "sps", "aps", "surv2m", "surv6m", "hday", "prg2m", "prg6m", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "adlsc")]))
rownames(pods) <- c("Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.", "NA's")
pods %>% kable() %>% kable_styling(full_width = T, bootstrap_options  = "striped")
```

Na podstawie powyższych danych, widzimy, że najmłodszy badany pacjent miał 18 lat, a najstarszy 101. Są pacjenci, którzy nie mają za sobą lat edukacji (wynik 0??). Jest pacjent, który za pobyt w szpitalu zapłacił niemal 1,5 mln dolarów. Min `totcst` - Całkowity stosunek kosztów do opłat (RCC) koszt wynisi 0 - ?? Min w `meanbp` - ciśnieniu tętniczym oraz `wblc`, `hrt`, `resp` - tzn. pacjent nie żyje?? - to samo z `glucose`, `urine`, `adlp`, `adls`, `adlsc`.

```{r}
dane[dane$meanbp==0,] |> nrow() #52
dane[dane$wblc==0,] |> nrow() #222
dane[dane$hrt==0,] |> nrow() #84
dane[dane$resp==0,] |> nrow() #66
dane[dane$glucose==0,] |> nrow() #4501
dane[dane$urine==0,] |> nrow() #4955
dane[dane$adlp==0,] |> nrow() #7490
dane[dane$adls==0,] |> nrow() #5975
dane[dane$adlsc==0,] |> nrow() #3108 razem prawie 25,5 tys.
```

Po przyjrzeniu się obserwacjom, dla których wymienione wyzej zmienne wynoszą 0, podjęto decyzję o nieusuwaniu ich ze zbioru danych. Gdy np. średnie ciśnienie tętnicze wynosi 0, większość z tych pacjentów w kolumnie `hospdead` (śmierć w szpitalu) czy `death` (śmierć w dowolnym momencie) ma wartość 1. Poza tym, wszystkich takich obserwacji z zerami dla tych zmiennych jest niemal 6 tysięcy.

Ponadto jest 13 zmiennych, dla których liczba braków danych przekracza 1000 - należy przeprowadzić dla nich odpowiednie metody imputacji braków.

Dla zmiennych kategorycznych prezentujemy ich możliwe poziomy oraz liczby wystąpień każdego poziomu:

```{r}
options(knitr.kable.NA='')
summary(dane[,c("death", "sex", "hospdead", "dzgroup", "dzclass", "income", "race", "diabetes", "dementia", "ca", "dnr", "sfdm2")]) %>% kable() %>% kable_styling(full_width = T, bootstrap_options  = "striped")
```

Na podstawie powyższej tabeli, widzimy, że w zmiennych `income` oraz `sfdm2` liczba braków danych jest duża (ponad 1000). Ponadto większość widocznych zmiennych kategorycznych charakteryzuje się niezbalansowaniem klasowym. Warto będzie rozważyć metody up-/downsamplingu.

#### Braki danych

Poniżej zaprezentowana jest liczba braków danych w każdej z kolumn.

```{r}
braki <- colSums(is.na(dane)) 

braki <- cbind(braki)

colnames(braki) <- "Liczba braków"

braki %>% kable() %>% kable_styling(full_width = F, bootstrap_options  = "striped")
```

Jak widać, braki danych pojawiają się w kolumnach: `edu`, `income`, `scoma` (tylko 1), `charges`, `totcst`, `totmcst`, `avisst`, `race`, `sps` (1), `aps` (1), `surv2m` (1), `surv6m` (1), `prg2m`, `prg6m`, `dnr`, `dnrday`, `meanbp` (1), `wblc`, `hrt` (1), `resp` (1), `temp` (1), `pafi`, `alb`, `bili`, `crea`, `sod` (1), `ph`, `glucose`, `bun`, `urine`, `adlp`, `adls` oraz `sfdm2.`

Aby przeprowadzić odpowiednią metodę imputacji braków danych, zostaną zbadane rozkłady poszczególnych zmiennych.

```{r}
dane |> select(c("age","slos", "d.time", "num.co", "edu", "scoma", "charges", "totcst", "totmcst", "avtisst", "sps", "aps", "surv2m", "surv6m", "hday", "prg2m", "prg6m", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "adlsc")) |> 
  pivot_longer(cols = everything()) |> 
  ggplot(aes(value, fill = name)) +
  geom_histogram(bins = 15, color = "white")+
  facet_wrap(~name, scales = "free")+
  labs(fill = "zmienne numeryczne")+
  theme(legend.position = "top")
```

Na podstawie powyższych rozkładów zmiennych numerycznych, widzimy, że:

-   lewostronnie asymetryczny jest rozkład zmiennych: (lekko) age, surv2m, surv6m

-   prawostronnie asymetryczny jest rozkład zmiennych: adlp, adls, alb, aps, avtisst, bili, bun, charges, crea, d.time, dnrday, edu (lekko), glucose, hday, hrt, num.co, pafi, resp, scoma, slos, (lekko) sod, sps, totcst, totmcst, urine, wblc

```{r}
dane |> select(-c("age","slos", "d.time", "num.co", "edu", "scoma", "charges", "totcst", "totmcst", "avtisst", "sps", "aps", "surv2m", "surv6m", "hday", "prg2m", "prg6m", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "adlsc")) |> 
  pivot_longer(cols = everything()) |> 
  ggplot(aes(value, fill = name)) +
  geom_bar()+
  facet_wrap(~name, scales = "free")+
  labs(fill = "zmienne kategoryczne")+
  theme(legend.position = "top")
```

Na podstawie powyższych rozkładów zmiennych kategorycznych, widzimy, że każda ze zmiennych charakteryzuje się niezbalansowaniem. Dla zmiennej dementia czy race poszczególne poziomy wyróżniają się naczącymi różnicami liczebnościowymi.

Ze względu na asymetrię rozkładów zmiennych ilościowych oraz niezbalansowanie zmiennych jakościowych, odrzucam dla nich imputację metodą najczęściej występującej wartości oraz medianą czy średnią. Zastosuję dla nich metodę imputacji $k$-najbliższych sąsiadów (tu 5).

```{r}
dane2 <- DMwR2::knnImputation(dane[,c("edu", "income", "scoma", "charges", "totcst", "totmcst", "avtisst", "race", "sps", "aps", "surv2m", "surv6m", "prg2m", "prg6m", "dnr", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "sfdm2")], k=5, meth='pmm')
dane3 <- bind_cols(dane[,c(1:9,22:25,47)], dane2)
```

#### Macierz korelacji

```{r}
mydata.cor = cor(dane3[,c("age","slos", "d.time", "num.co", "edu", "scoma", "charges", "totcst", "totmcst", "avtisst", "sps", "aps", "surv2m", "surv6m", "hday", "prg2m", "prg6m", "dnrday", "meanbp", "wblc", "hrt", "resp", "temp", "pafi", "alb", "bili", "crea", "sod", "ph", "glucose", "bun", "urine", "adlp", "adls", "adlsc")], use = "na.or.complete")
corrplot(mydata.cor, tl.cex = 0.6)
```

Z macierzy korelacji dla zmiennych numerycznych, wyczytać możemy, że istnieją bardzo silne korelacje pomiędzy zmiennymi: slos oraz dnrday, surv6m i surf2m, surv2m i sps, prg2m oraz prg6m, charges z totcst i totmcst, aps i sps, adls i adlsc.

```{r}
cor(dane3$slos, dane3$dnrday) #0.88
cor(dane3$surv6m, dane3$surv2m) #0.96
cor(dane3$surv2m, dane3$sps) #-0.76
cor(dane3$prg2m, dane3$prg6m) #0.90
cor(dane3$charges, dane3$totcst) #0.81
cor(dane3$charges, dane3$totmcst) #0.74
cor(dane3$totcst, dane3$totmcst) #0.86
cor(dane3$aps, dane3$sps) #0.80
cor(dane3$adls, dane3$adlsc) #0.91
```

Należy rozważyć metody redukujące wymiary, np. PCA.

#### Wartości odstające

```{r}
nearZeroVar(dane3) #dementia
```

Dla zmiennej `dementia` stosunek częstotliwości najczęściej występującej wartości do częstotliwości drugiej najczęściej występującej wartości jest duży.

```{r}
dane3 |> 
  select(where(is.numeric)) |> 
  findLinearCombos()
```

Brak jest również w tym zbiorze danych kombinacji liniowych pomiędzy predyktorami.

```{r}
dane3 |> 
  select(-c("death", "sex", "hospdead", "dzgroup", "dzclass", "diabetes", "dementia", "ca", "income", "race", "dnr", "sfdm2")) |> 
  pivot_longer(cols = everything()) |> 
  ggplot(aes(value, fill = name)) +
  geom_boxplot()+
  facet_wrap(~name, scales = "free")+
  theme(legend.position = "top")
```

Powyższe wykresy ramka-wąsy wskazują, że niemal dla każdej zmiennej numerycznej istnieją wartości odstające.

```{r}
identify_outliers(dane3, colnames(dane3)[1])[identify_outliers(dane3, colnames(dane3)[1])$is.extreme==T,] |> nrow() #age - 56, brak extreme
identify_outliers(dane3, colnames(dane3)[5])[identify_outliers(dane3, colnames(dane3)[5])$is.extreme==T,] |> nrow() #slos - 768, 347 extreme
identify_outliers(dane3, colnames(dane3)[6])[identify_outliers(dane3, colnames(dane3)[6])$is.extreme==T,] |> nrow() #d.time - 267, brak extreme
identify_outliers(dane3, colnames(dane3)[9])[identify_outliers(dane3, colnames(dane3)[9])$is.extreme==T,] |> nrow() #num.co - 25, brak extreme
identify_outliers(dane3, colnames(dane3)[10])[identify_outliers(dane3, colnames(dane3)[10])$is.extreme==T,] |> nrow() #hday - 1543, 1118 extreme
identify_outliers(dane3, colnames(dane3)[14]) |> nrow() #adlsc - brak
identify_outliers(dane3, colnames(dane3)[15])[identify_outliers(dane3, colnames(dane3)[15])$is.extreme==T,] |> nrow() #edu - 654, 68 extreme
identify_outliers(dane3, colnames(dane3)[17])[identify_outliers(dane3, colnames(dane3)[17])$is.extreme==T,] |> nrow() #scoma - 1955, 1516 extreme
identify_outliers(dane3, colnames(dane3)[18])[identify_outliers(dane3, colnames(dane3)[18])$is.extreme==T,] |> nrow() #charges - 931, 455 extreme
identify_outliers(dane3, colnames(dane3)[19])[identify_outliers(dane3, colnames(dane3)[19])$is.extreme==T,] |> nrow() #totcst - 856, 384 extreme
identify_outliers(dane3, colnames(dane3)[20])[identify_outliers(dane3, colnames(dane3)[20])$is.extreme==T,] |> nrow() #totmcst - 800, 401 extreme
identify_outliers(dane3, colnames(dane3)[21])[identify_outliers(dane3, colnames(dane3)[21])$is.extreme==T,] |> nrow() #avtisst - 48, brak extreme
identify_outliers(dane3, colnames(dane3)[23])[identify_outliers(dane3, colnames(dane3)[23])$is.extreme==T,] |> nrow() #sps - 283, 70 extreme
identify_outliers(dane3, colnames(dane3)[24])[identify_outliers(dane3, colnames(dane3)[24])$is.extreme==T,] |> nrow() #aps - 178, 5 extreme
identify_outliers(dane3, colnames(dane3)[25]) |> nrow() #surv2m - 307, brak extreme
identify_outliers(dane3, colnames(dane3)[26]) |> nrow() #surv6m - brak
identify_outliers(dane3, colnames(dane3)[27]) |> nrow() #prg2m - brak
identify_outliers(dane3, colnames(dane3)[28]) |> nrow() #prg6m - brak
identify_outliers(dane3, colnames(dane3)[30]) |> nrow() #dnrday - 801, 332 extreme
identify_outliers(dane3, colnames(dane3)[31])[identify_outliers(dane3, colnames(dane3)[31])$is.extreme==T,] |> nrow() #meanbp - 6, brak extreme
identify_outliers(dane3, colnames(dane3)[32])[identify_outliers(dane3, colnames(dane3)[32])$is.extreme==T,] |> nrow() #wblc - 400, 123 extreme
identify_outliers(dane3, colnames(dane3)[33])[identify_outliers(dane3, colnames(dane3)[33])$is.extreme==T,] |> nrow() #hrt - 40, 1 extreme
identify_outliers(dane3, colnames(dane3)[34])[identify_outliers(dane3, colnames(dane3)[34])$is.extreme==T,] |> nrow() #resp - 313, 23 extreme
identify_outliers(dane3, colnames(dane3)[35])[identify_outliers(dane3, colnames(dane3)[35])$is.extreme==T,] |> nrow() #temp - 14, brak extreme
identify_outliers(dane3, colnames(dane3)[36])[identify_outliers(dane3, colnames(dane3)[36])$is.extreme==T,] |> nrow() #pafi - 189, 12 extreme
identify_outliers(dane3, colnames(dane3)[37])[identify_outliers(dane3, colnames(dane3)[37])$is.extreme==T,] |> nrow() #alb - 93, 4 extreme
identify_outliers(dane3, colnames(dane3)[38])[identify_outliers(dane3, colnames(dane3)[38])$is.extreme==T,] |> nrow() #bili - 1165, 707 extreme
identify_outliers(dane3, colnames(dane3)[39])[identify_outliers(dane3, colnames(dane3)[39])$is.extreme==T,] |> nrow() #crea - 988, 538 extreme
identify_outliers(dane3, colnames(dane3)[40])[identify_outliers(dane3, colnames(dane3)[40])$is.extreme==T,] |> nrow() #sod - 256, 16 extreme
identify_outliers(dane3, colnames(dane3)[41])[identify_outliers(dane3, colnames(dane3)[41])$is.extreme==T,] |> nrow() #ph - 372,59 extreme
identify_outliers(dane3, colnames(dane3)[42])[identify_outliers(dane3, colnames(dane3)[42])$is.extreme==T,] |> nrow() #glucose - 482, 148 extreme
identify_outliers(dane3, colnames(dane3)[43])[identify_outliers(dane3, colnames(dane3)[43])$is.extreme==T,] |> nrow() #bun - 648, 148 extreme
identify_outliers(dane3, colnames(dane3)[44])[identify_outliers(dane3, colnames(dane3)[44])$is.extreme==T,] |> nrow() #urine - 378, 74 extreme
identify_outliers(dane3, colnames(dane3)[45])[identify_outliers(dane3, colnames(dane3)[45])$is.extreme==T,] |> nrow() #adlp - 420, 53 extreme
identify_outliers(dane3, colnames(dane3)[46])[identify_outliers(dane3, colnames(dane3)[46])$is.extreme==T,] |> nrow() #adls - 707, brak extreme
```

Obserwacje zidentyfikowane jako odstające nie zidentyfikowano tylko dla czterech zmiennych. Najliczniej występują one dla zmiennej `scoma` i ich liczba wynosi niemal dwa tysiące. Samych wartości ekstremalnych dla tej zminnej jest nieco ponad 1,5 tysiąca. Usunięcie tych obserwacji to pozbycie się prawie 20% zbioru, co byłoby niepoprawnym działaniem. Na ten moment zidentyfikowane wartości odstające poztstaną niezmienne.

## Wizualizacje zbioru

## **Przygotowanie danych do budowy modelu**

Chcąc rozwiązać zadanie klasyfikacyjne z wieloma wyjściami postanowiłem przygotować dwa zestawy danych uczących. Jeden by nie stosował metod *upsamplingu,* natomiast do drugiego zastosowałbym metodę MLSMOTE (ang. *Synthetic oversampling of multilabel instances*). W ramach preprocesingu ograniczę się do standaryzacji zmiennych (również na potrzeby stosowania MLSMOTE, ponieważ jest ona oparta o odległości pomiędzy obiektami - kNN), zamiany zmiennej jakościowej na *dummy variable*. Do oceny dopasowania modeli zastosuję miary zarówno na poziomie pojedynczych etykiet, jaki i zestawów etykiet. Jako model, którego użyję do porównań posłuży mi SVM w różnych wariantach:

-   *binary revelance -* jest to adaptacja powszechnie znanego podejścia *one-vs-all*. Metoda ta przekształca oryginalny wieloetykietowy zbiór danych w kilka binarnych zbiorów danych, tyle ile jest różnych etykiet. W ten sposób można użyć dowolnego klasyfikatora binarnego, łącząc ich indywidualne przewidywania w celu wygenerowania ostatecznego wyniku.

-   *label powerset* - metoda ta przekształca zbiór danych wieloetykietowych w zbiór danych wieloklasowych, wykorzystując zestaw etykiet każdej instancji jako identyfikator klasy. Można użyć dowolnego klasyfikatora wieloklasowego, przekształcając przewidywaną klasę z powrotem w zestaw etykiet.

-   *classifier chains -* poznany na wykładzie.

++ sieci neuronowe
